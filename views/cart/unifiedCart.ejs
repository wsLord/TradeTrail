<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Cart</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/cart.css">
  <link rel="stylesheet" href="/css/forms.css">
  <link rel="stylesheet" href="/css/rentalStyles.css">
  <link rel="icon" type="image/png" href="/assets/logo2.png">
  
  <style>
    .cart-section {
      margin: 2rem 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 1rem;
      background-color: #f5f5f5;
      border-radius: 6px;
    }
    .section-content {
      display: none;
      margin-top: 1rem;
    }
    .section-content.active {
      display: block;
    }
    .toggle-btn {
      font-size: 1.5rem;
      /* background: none; */
      background-color: #838383;
      border: none;
      cursor: pointer;
      padding: 0 1rem;
    }
    .rental-details {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .price-breakdown {
      margin-top: 10px;
      padding-left: 20px;
      border-left: 3px solid #007bff;
    }
  </style>
</head>

<body>
  <div id="navbar">
    <%- include('../common/navigation.ejs') %>
  </div>
  <main class="cart-container">
    <div class="cart-header">
      <h1>Your Cart</h1>
    </div>

    <% const sections = {
      Rental: cart.items.filter(item => item.productType === 'Rental'),
      Subscription: cart.items.filter(item => item.productType === 'Subscription'),
      SecondHand: cart.items.filter(item => item.productType === 'SecondHand')
    };
    let grandTotal = 0;
    let depositTotal = 0;
    %>

    <% Object.entries(sections).forEach(([sectionName, items]) => { %>
      <div class="cart-section">
        <div class="section-header" onclick="toggleSection('<%= sectionName %>')">
          <h2><%= sectionName %> (<%= items.length %>)</h2>
          <button class="toggle-btn" data-section="<%= sectionName %>">+</button>
        </div>
        <div class="section-content" id="<%= sectionName %>-content">
          <% if (items.length === 0) { %>
            <p>No <%= sectionName %> items in cart</p>
          <% } else { %>
            <table class="cart-items">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Title</th>
                  <% if (sectionName === 'Rental') { %>
                    <th>Rental Period</th>
                    <th>Rate</th>
                  <% } else if (sectionName === 'Subscription') { %>
                    <th>Platform</th>
                  <% } %>
                  <th>Unit Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(item => { 
                  let totalPrice = 0;
                  let itemDeposit = 0;
                  
                  if (sectionName === 'Rental') {
                    totalPrice = item.calculatedPrice * item.quantity;
                    itemDeposit = item.securityDeposit;
                    depositTotal += itemDeposit;
                  } else {
                    totalPrice = item.product.price * item.quantity;
                  }
                  
                  grandTotal += totalPrice;
                %>
                  <tr class="cart-item">
                    <td>
                      <img src="<%= item.product.imageUrl %>" alt="<%= item.product.title %>" style="max-width: 100px;">
                    </td>
                    <td><%= item.product.title || item.product.platform_name %></td>
                    
                    <% if (sectionName === 'Rental') { %>
                      <td>
                        <% if (item.rentalStart && item.rentalEnd) { %>
                          <div class="rental-details">
                            <%= item.rentalStart.toISOString().split('T')[0] %> to 
                            <%= item.rentalEnd.toISOString().split('T')[0] %>
                            <% 
                              const diffTime = item.rentalEnd - item.rentalStart;
                              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            %>
                            (<%= diffDays %> days)
                          </div>
                        <% } else { %>
                          <div class="text-warning">Dates not selected</div>
                        <% } %>
                      </td>
                      <td>
                        <div class="price-breakdown">
                          ₹<%= item.product.price %>/<%= item.product.rate %>
                          <% if (item.product.rate === 'day' && diffDays > 1) { %>
                            × <%= diffDays %> days
                          <% } %>
                        </div>
                      </td>
                    <% } else if (sectionName === 'Subscription') { %>
                      <td><%= item.product.platform_name %></td>
                    <% } %>

                    <td>
                      ₹<%= sectionName === 'Rental' ? 
                        item.calculatedPrice.toFixed(2) : 
                        item.product.price.toFixed(2) %>
                      <% if (sectionName === 'Rental') { %>
                        <div class="security-deposit">
                          + ₹<%= item.securityDeposit %> deposit
                        </div>
                      <% } %>
                    </td>

                    <td>
                      <% if (sectionName === 'Rental') { %>
                        <span><%= item.quantity %></span>
                      <% } else { %>
                        <form action="/cart/update/<%= item._id %>" method="POST">
                          <input type="number" name="quantity" value="<%= item.quantity %>" 
                                 min="1" max="<%= item.product.quantity %>" class="quantity-input">
                          <button type="submit">Update</button>
                        </form>
                      <% } %>
                    </td>

                    <td>
                      ₹<%= (totalPrice + (sectionName === 'Rental' ? itemDeposit : 0)).toFixed(2) %>
                      <% if (sectionName === 'Rental') { %>
                        <div class="price-breakdown">
                          (₹<%= totalPrice.toFixed(2) %> + 
                          ₹<%= itemDeposit.toFixed(2) %> deposit)
                        </div>
                      <% } %>
                    </td>

                    <td>
                      <form action="/cart/delete/<%= item._id %>" method="POST">
                        <button type="submit" class="delete-button" 
                                style="background-color: black; color: white;">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          <% } %>
        </div>
      </div>
    <% }); %>

    <% if (cart.items.length > 0) { %>
      <div class="cart-total">
        <% if (depositTotal > 0) { %>
          <h4>Total Security Deposits: ₹<%= depositTotal.toFixed(2) %></h4>
        <% } %>
        <h3>Grand Total: ₹<%= grandTotal.toFixed(2) %></h3>
      </div>
      <div style="clear: both;"></div>
      <button class="checkout-button">Proceed to Checkout</button>
    <% } %>
  </main>

  <script>
    function toggleSection(sectionName) {
      const content = document.getElementById(`${sectionName}-content`);
      const btn = document.querySelector(`[data-section="${sectionName}"]`);
      content.classList.toggle('active');
      btn.textContent = content.classList.contains('active') ? '-' : '+';
    }

    // Expand first non-empty section
    document.querySelectorAll('.cart-section').forEach(section => {
      if (section.querySelector('.cart-item')) {
        const sectionName = section.querySelector('h2').textContent.split(' ')[0];
        toggleSection(sectionName);
      }
    });
  </script>
</body>
</html>